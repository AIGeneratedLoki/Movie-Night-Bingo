<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Trope Bingo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styles --- */
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }
        .main-page-bg {
            background-image: url('https://i.imgur.com/Uu5Lzho.jpeg');
        }
        .game-page-bg {
            background-image: url('https://i.imgur.com/3odwMDB.jpeg');
        }
        .container {
            background-color: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.2);
            width: 100%;
            max-width: 600px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
            border-right: 1px solid rgba(0, 0, 0, 0.5);
        }
        h1, h2, h3 { color: #e94560; font-weight: 700; text-transform: uppercase; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .hidden { display: none; }

        /* --- Form Styles --- */
        .form-group { margin-bottom: 20px; text-align: left; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px;
            border-radius: 8px;
            font-family: 'Exo 2', sans-serif;
            background-color: rgba(0, 0, 0, 0.65);
            border: 1px solid #111;
            border-top-color: #000;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            color: #e0e0e0;
        }
        input::placeholder { color: #a0a0a0; }
        .btn, .btn-play, .btn-new-game {
            background: linear-gradient(to bottom, #888, #444);
            border: 1px solid #999;
            border-top-color: #aaa;
            border-bottom-color: #333;
            box-shadow: 0 1px 0 rgba(255,255,255,0.2) inset;
            text-shadow: 0 -1px 1px rgba(0,0,0,0.5);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
        }
         .btn:hover, .btn-play:hover, .btn-new-game:hover {
            background: linear-gradient(to bottom, #999, #555);
        }
        .btn-play {
             background: linear-gradient(to bottom, #e94560, #a12d3e);
        }
        .btn-play:hover {
             background: linear-gradient(to bottom, #ff607e, #b13d4e);
        }
        
        /* --- Title Input with Random Button --- */
        .title-input-group { display: flex; gap: 10px; }
        .title-input-group input { flex-grow: 1; }
        #random-btn, #remix-name-btn {
            padding: 0 15px; font-size: 1em; flex-shrink: 0; width: auto;
            display: flex; align-items: center; justify-content: center;
        }
        #random-btn svg, #remix-name-btn svg { width: 24px; height: 24px; fill: white; }

        /* --- Suggestions Dropdown --- */
        .suggestions-container {
            position: absolute; top: 100%; left: 0; right: 0;
            background: linear-gradient(145deg, #2e2e34, #1a1a1e);
            border: 1px solid #555;
            border-top: none;
            border-radius: 0 0 8px 8px; z-index: 10; max-height: 450px; overflow-y: auto;
        }
        .suggestion-item {
            display: flex; align-items: center; gap: 15px; padding: 10px; cursor: pointer;
            text-align: left; border-bottom: 1px solid #444;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: rgba(83, 52, 131, 0.5); }
        .suggestion-poster { width: 60px; height: 90px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .suggestion-info { flex-grow: 1; }
        .suggestion-info strong { font-size: 1.1em; color: #e0e0e0; }
        .suggestion-info small { color: #a0a0a0; margin-left: 5px; }
        .suggestion-overview {
            font-size: 0.85em; color: #b0b0b0; margin: 5px 0; display: -webkit-box;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .suggestion-rating { font-size: 0.9em; color: #e94560; }

        /* --- Random Screen Styles --- */
        .filters {
            display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;
            border-bottom: 2px solid #555; padding-bottom: 20px;
        }
        .filter-group { flex: 1; min-width: 150px; }
        #random-results { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
        .button-group { display: flex; gap: 10px; }

        /* --- Welcome & Error Messages --- */
        .welcome-back { background-color: rgba(15, 52, 96, 0.5); border: 1px solid #444; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .error { color: #e94560; font-weight: bold; margin-bottom: 15px; }

        /* --- Game Screen Styles --- */
        .game-container {
            max-width: 800px;
            background-color: transparent;
            backdrop-filter: none;
            border: none;
            box-shadow: none;
        }
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.65);
            padding: 20px;
            border-radius: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: 1px solid rgba(0, 0, 0, 0.5);
            border-right: 1px solid rgba(0, 0, 0, 0.5);
        }
        .game-instructions {
            font-style: italic;
            color: #ccc;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid #444;
        }
        .movie-info { display: flex; flex-wrap: wrap; gap: 20px; text-align: left; }
        .movie-info img { max-width: 100px; border-radius: 8px; }
        .movie-info .details { flex: 1; min-width: 150px; }
        .player-info { text-align: right; }
        #player-name-display { font-size: 1.8em; margin: 0; line-height: 1; word-break: break-word; }
        #bingo-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 30px; }
        .bingo-cell {
            background: rgba(0, 0, 0, 0.65);
            border: 1px solid #111;
            border-top-color: #555;
            border-left-color: #555;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 1px 5px rgba(0,0,0,0.5);
            border-radius: 8px;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            font-size: clamp(0.6em, 2.5vw, 0.9em);
            transition: all 0.3s;
            user-select: none;
        }
        .bingo-cell:hover { border-color: #e94560; }
        .bingo-cell.marked { 
            background: linear-gradient(145deg, #ff506e, #e94560);
            color: white; 
            transform: scale(0.95); 
            font-weight: bold; 
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .game-footer-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        .btn-new-game, #clear-board-btn, #win-by-points-btn, #did-not-win-btn {
            margin-top: 0;
            font-size: 1em;
            padding: 10px 25px;
            width: auto;
        }
        #current-score-display {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        /* --- Pop-up & Overlay Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); z-index: 99;
        }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #2e2e34, #1a1a1e);
            padding: 30px 40px;
            border-radius: 8px;
            border-top: 1px solid #555;
            border-left: 1px solid #555;
            border-right: 1px solid #222;
            border-bottom: 1px solid #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
            z-index: 100;
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
        .modal p {
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        .modal-poster {
            max-width: 150px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #confirm-yes-btn, #close-win-popup {
             background: linear-gradient(to bottom, #e94560, #a12d3e);
        }
        #confirm-yes-btn:hover, #close-win-popup:hover {
             background: linear-gradient(to bottom, #ff607e, #b13d4e);
        }

        /* --- Celebration Overlay --- */
        .celebration-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 101; pointer-events: none;
            overflow: hidden;
        }
        .celebration-particle {
            position: absolute;
            border-radius: 50%;
            animation: burst 2s ease-out forwards;
        }
        @keyframes burst {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5) translate(var(--x), var(--y)); opacity: 0; }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            top: -50px;
            animation: fall 2s linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }
        .balloon {
            position: absolute;
            bottom: -150px;
            width: 75px;
            height: 100px;
            border-radius: 50%;
            animation: floatUp 2s ease-out forwards;
        }
        @keyframes floatUp {
            to { transform: translateY(-120vh); }
        }

        /* --- Watchlist & Stats Styles --- */
        #watchlist-container, #trope-stats-container {
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 20px;
        }
        .watchlist-item, .stat-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }
        .watchlist-item { cursor: pointer; }
        .watchlist-item .priority {
            font-size: 2em;
            font-weight: bold;
            color: #e94560;
            padding: 0 15px;
        }
        .watchlist-item .suggestion-info {
            text-align: left;
        }
        .overall-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background-color: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
        }
        .stat-box { text-align: center; }
        .stat-box .number { font-size: 2.5em; color: #e94560; }
        .stat-box .label { font-size: 0.9em; text-transform: uppercase; }
        .stat-row .trope-name { flex-basis: 40%; text-align: left; }
        .stat-row .trope-seen, .stat-row .trope-won, .stat-row .trope-rate { flex-basis: 20%; text-align: center; }

        /* --- Mobile Specific Styles --- */
        @media (max-width: 640px) {
            .game-header {
                flex-direction: column;
                text-align: center;
            }
            .player-info {
                text-align: center;
                margin-top: 15px;
            }
            #player-name-display {
                font-size: 1.8em;
            }
            .movie-info {
                justify-content: center;
            }
            .movie-info .details {
                text-align: center;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="main-page-bg">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="container">
        <h1>Movie Night Tools</h1>
        <div class="button-group" style="flex-direction: column; gap: 20px;">
            <button id="bingo-btn" class="btn">Bingo</button>
            <button id="watchlist-btn" class="btn">You Gotta Watch This</button>
            <button id="stats-btn" class="btn">Nerd Stuff</button>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="container hidden">
        <div class="button-group" style="margin-bottom: 20px;">
             <button id="home-btn" class="btn" style="width: auto; padding: 10px 20px; font-size: 1em;">Home</button>
        </div>
        <h1>Movie Trope Bingo</h1>
        <div id="welcome-message" class="welcome-back hidden"></div>
        <div id="error-message" class="error"></div>
        
        <form id="setup-form">
            <div class="form-group">
                <label for="movie_title">Enter Movie Title</label>
                <div class="title-input-group">
                    <input type="text" id="movie_title" name="movie_title" required autocomplete="off">
                    <button type="button" id="random-btn" class="btn" aria-label="Find a random movie">
                        <svg viewBox="0 0 24 24"><path d="M3,2H21V4H20A2,2 0 0,0 18,6V11.34C17.45,11.12 16.74,11 16,11C14.39,11 12.94,11.81 12,13C11.06,11.81 9.61,11 8,11C6.26,11 4.7,11.9 3.82,13.24L3,13.5V2M18,13A3,3 0 0,1 21,16A3,3 0 0,1 18,19A3,3 0 0,1 15,16A3,3 0 0,1 18,13M8,13A3,3 0 0,1 11,16A3,3 0 0,1 8,19A3,3 0 0,1 5,16A3,3 0 0,1 8,13Z" /></svg>
                    </button>
                </div>
                <div id="movie-suggestions" class="suggestions-container"></div>
            </div>
            <div class="form-group">
                <label for="genre">Select Genre</label>
                <select name="genre" id="genre-select"></select>
            </div>
            <div class="form-group">
                <label for="player_name">Your Name (optional)</label>
                <div class="title-input-group">
                    <input type="text" id="player_name" name="player_name" placeholder="Leave blank for a random name">
                    <button type="button" id="remix-name-btn" class="btn" aria-label="Get a random name">
                        <svg viewBox="0 0 24 24"><path d="M12,23C11.2,23 10.4,22.7 9.8,22.1L3.5,15.8C2.3,14.6 2.3,12.7 3.5,11.5C4.7,10.3 6.6,10.3 7.8,11.5L10.2,13.9L12.5,11.5C13.7,10.3 15.6,10.3 16.8,11.5L19.2,13.9L21.5,11.5C22.7,10.3 24.6,10.3 25.8,11.5C27,12.7 27,14.6 25.8,15.8L19.5,22.1C18.9,22.7 18.1,23 17.3,23C16.5,23 15.7,22.7 15.1,22.1L12.8,19.8L10.5,22.1C9.9,22.7 9.1,23 8.3,23H8.3M7.8,13.9C7.2,13.3 6.2,13.3 5.6,13.9C5,14.5 5,15.5 5.6,16.1L11.9,22.4C12.5,23 13.5,23 14.1,22.4L20.4,16.1C21,15.5 21,14.5 20.4,13.9C19.8,13.3 18.8,13.3 18.2,13.9L15.8,16.2L13.5,13.9C12.3,12.7 10.4,12.7 9.2,13.9L7.8,15.3V13.9Z" transform="translate(-4 -4) scale(1.2)"/></svg>
                    </button>
                </div>
            </div>
            <div class="button-group">
                <button type="button" id="clear-btn" class="btn">Clear</button>
                <button type="submit" class="btn-play">Let's Play!</button>
            </div>
        </form>
    </div>

    <!-- Random Movie Screen -->
    <div id="random-screen" class="container hidden">
        <h2>Find a Random Movie</h2>
        <div class="filters">
            <div class="filter-group">
                <label for="random-genre-select">Genre</label>
                <select id="random-genre-select"></select>
            </div>
            <div class="filter-group">
                <label for="year-from">Year From</label>
                <input type="number" id="year-from" placeholder="e.g., 1980">
            </div>
            <div class="filter-group">
                <label for="year-to">Year To</label>
                <input type="number" id="year-to" placeholder="e.g., 2024">
            </div>
        </div>
        <div id="random-results"></div>
        <div class="button-group">
            <button type="button" id="back-btn" class="btn">Back</button>
            <button type="button" id="reshuffle-btn" class="btn">Reshuffle</button>
            <button type="button" id="find-random-btn" class="btn">Find Movies</button>
        </div>
    </div>

    <!-- Watchlist Screen -->
    <div id="watchlist-screen" class="container hidden">
        <div class="button-group" style="margin-bottom: 20px;">
             <button id="watchlist-home-btn" class="btn" style="width: auto; padding: 10px 20px; font-size: 1em;">Home</button>
        </div>
        <h2>You Gotta Watch This</h2>
        <div class="form-group">
            <label for="watchlist-search">Add a Movie</label>
            <input type="text" id="watchlist-search" placeholder="Search for a movie to add..." autocomplete="off">
            <div id="watchlist-suggestions" class="suggestions-container"></div>
        </div>
        <div id="watchlist-container"></div>
    </div>

    <!-- Stats Screen -->
    <div id="stats-screen" class="container hidden">
        <div class="button-group" style="margin-bottom: 20px;">
             <button id="stats-home-btn" class="btn" style="width: auto; padding: 10px 20px; font-size: 1em;">Home</button>
        </div>
        <h2>Nerd Stuff</h2>
        <div class="overall-stats">
            <div class="stat-box">
                <div id="stats-wins" class="number">0</div>
                <div class="label">Wins</div>
            </div>
            <div class="stat-box">
                <div id="stats-losses" class="number">0</div>
                <div class="label">Losses</div>
            </div>
            <div class="stat-box">
                <div id="stats-win-rate" class="number">0%</div>
                <div class="label">Win Rate</div>
            </div>
             <div class="stat-box">
                <div id="stats-total-points" class="number">0</div>
                <div class="label">Total Points</div>
            </div>
            <div class="stat-box">
                <div id="stats-avg-points" class="number">0</div>
                <div class="label">Avg. Points</div>
            </div>
        </div>
        <h3>Trope Stats</h3>
        <div id="trope-stats-container"></div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="container game-container hidden">
        <div class="game-header">
            <div class="movie-info">
                <img id="movie-poster" src="" alt="Movie Poster" onerror="this.style.display='none'">
                <div class="details">
                    <h2 id="movie-title-display"></h2>
                    <p><strong>Genre:</strong> <span id="game-genre"></span></p>
                    <p><strong>Runtime:</strong> <span id="movie-runtime"></span> minutes</p>
                    <p><strong>Rating:</strong> <span id="movie-rating"></span> / 5.0 ★</p>
                </div>
            </div>
            <div class="player-info">
                <h2 id="player-name-display"></h2>
            </div>
        </div>
        <p class="game-instructions"><strong>Single-Click:</strong> Trope Description | <strong>Double-Click:</strong> Mark Square</p>
        <div id="current-score-display">Current Score: 0</div>
        <div id="bingo-card"></div>
        <div class="game-footer-buttons">
            <button id="win-by-points-btn" class="btn btn-new-game">Win by Points</button>
            <button id="did-not-win-btn" class="btn btn-new-game">I Didn't Win</button>
            <button id="clear-board-btn" class="btn btn-new-game">Clear Board</button>
            <button id="new-game-btn" class="btn btn-new-game">New Game</button>
        </div>
    </div>

    <!-- Popups -->
    <div id="modal-overlay" class="modal-overlay hidden"></div>
    <div id="celebration-overlay" class="celebration-overlay hidden"></div>
    <div id="win-popup" class="modal hidden">
        <h2>BINGO!</h2>
        <p>You won! 25 points added to your score.</p>
        <button id="close-win-popup" class="btn">Awesome!</button>
    </div>
    <div id="trope-detail-popup" class="modal hidden">
        <h3 id="trope-detail-title"></h3>
        <p id="trope-detail-desc"></p>
        <button id="close-trope-popup" class="btn">Got it</button>
    </div>
    <div id="confirm-new-game-popup" class="modal hidden">
        <h3>Start a New Game?</h3>
        <p>Are you sure you want to end this game and return to the main menu? Your total score will be saved.</p>
        <div class="button-group">
            <button id="confirm-cancel-btn" class="btn">Cancel</button>
            <button id="confirm-yes-btn" class="btn">Yes, New Game</button>
        </div>
    </div>
    <div id="add-movie-popup" class="modal hidden">
        <img id="add-movie-poster" src="" alt="Movie Poster" class="modal-poster">
        <h3 id="add-movie-title"></h3>
        <p id="add-movie-overview"></p>
        <div class="form-group">
            <label for="priority-select">Priority (1=Low, 5=High)</label>
            <select id="priority-select">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <button id="add-to-watchlist-btn" class="btn">Add to List</button>
    </div>
    <div id="edit-movie-popup" class="modal hidden">
        <img id="edit-movie-poster" src="" alt="Movie Poster" class="modal-poster">
        <h3 id="edit-movie-title"></h3>
        <p id="edit-movie-overview"></p>
        <div class="form-group">
            <label for="edit-priority-select">Priority (1=Low, 5=High)</label>
            <select id="edit-priority-select"></select>
        </div>
        <div class="button-group">
            <button id="delete-movie-btn" class="btn">Delete</button>
            <button id="update-movie-btn" class="btn">Update</button>
        </div>
    </div>
     <div id="confirm-delete-popup" class="modal hidden">
        <h3>Delete Movie?</h3>
        <p>Are you sure you want to remove this movie from your watchlist?</p>
        <div class="button-group">
            <button id="delete-cancel-btn" class="btn">Cancel</button>
            <button id="delete-confirm-btn" class="btn">Yes, Delete</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const TMDB_API_KEY = '678e19862c579742e5476208479c8e6c';
            const TROPES_DATA = {
                "Action": [
                    { "name": "One-Liner", "desc": "The hero says a witty or pithy remark right before or after dispatching a villain. It's often a pun related to the villain's demise." }, { "name": "Car Chase", "desc": "A high-speed pursuit between vehicles that often defies the laws of physics, involving impossible drifts, jumps, and conveniently empty fruit stands." }, { "name": "Explosion Walk", "desc": "The hero walks calmly away from a massive explosion behind them, without looking back, as if it's a completely normal occurrence." }, { "name": "Gets Knocked Out", "desc": "A character is rendered unconscious by a blow to the head, only to wake up later with no serious medical consequences, often in the villain's lair." }, { "name": "Villain Monologue", "desc": "The villain, having captured the hero, explains their entire evil plan in detail instead of just finishing them off, giving the hero time to escape." }, { "name": "Bottomless Mags", "desc": "A character fires their weapon far more times than its magazine capacity should allow, without ever seeming to reload." }, { "name": "Stormtrooper Aim", "desc": "Countless enemy henchmen fire at the hero but consistently miss, while the hero can pick them off with impossible accuracy." }, { "name": "Training Montage", "desc": "A sequence showing the hero rapidly improving their skills over a short period, set to inspirational music." }, { "name": "Wire Fu", "desc": "Characters perform acrobatic, gravity-defying martial arts feats, clearly assisted by wires that allow them to leap and fly through the air." }, { "name": "Gearing Up", "desc": "A scene dedicated to the hero (or team) meticulously selecting and equipping their weapons and gadgets in preparation for a major confrontation." }, { "name": "Just in Time", "desc": "The hero arrives to save the day or defuse a bomb at the absolute last possible second." }, { "name": "That's Gonna Hurt", "desc": "A character sustains an injury that would be debilitating or fatal in real life but simply shakes it off after a brief wince." }, { "name": "Convenient Ramp", "desc": "During a car chase, a conveniently placed truck, ramp, or pile of debris allows a vehicle to perform a spectacular jump." }, { "name": "Precarious Ledge", "desc": "A fight or chase sequence takes place on a narrow ledge, high above a dangerous drop." }, { "name": "Two-Person Key", "desc": "A security system that requires two people to turn keys or press buttons simultaneously, usually far apart from each other." }, { "name": "Red Wire, Blue Wire", "desc": "A hero must defuse a bomb by choosing which wire to cut, almost always with one second to spare." }, { "name": "Bulletproof Human", "desc": "The hero endures multiple gunshot wounds that would be fatal to anyone else, yet continues to fight." }, { "name": "Gun Fu", "desc": "A stylized form of combat that combines martial arts with gunplay in an almost dance-like sequence." }, { "name": "Improbable Aim", "desc": "A character makes an incredibly difficult shot, like shooting a rope to save someone, that would be nearly impossible in reality." }, { "name": "Run For Your Life", "desc": "Characters try to outrun a massive explosion, collapsing building, or other large-scale disaster." }, { "name": "Slow-Motion Dodge", "desc": "The hero dodges bullets or attacks in dramatic slow motion, highlighting their incredible reflexes." }, { "name": "Knife vs. Gun", "desc": "A character with a knife somehow manages to be a serious threat to an opponent with a firearm." }, { "name": "The Cavalry Arrives", "desc": "Just when the heroes are hopelessly outnumbered and about to be defeated, reinforcements arrive to turn the tide." }, { "name": "Explosive Decompression", "desc": "A small hole in a spaceship or airplane causes a violent, explosive rush of air that sucks people out." }
                ],
                "Comedy": [
                    { "name": "Awkward Dinner", "desc": "A meal scene where social tension, embarrassing revelations, or clashing personalities create painfully funny and uncomfortable situations." }, { "name": "Banana Peel Slip", "desc": "A character comically slips on a banana peel or a similarly placed object, a classic slapstick gag." }, { "name": "Running Gag", "desc": "A humorous line, action, or situation that is repeated throughout the movie, becoming funnier with each occurrence." }, { "name": "Fourth-Wall Break", "desc": "A character directly addresses the audience, acknowledging that they are in a movie." }, { "name": "Comedic Slow-Mo", "desc": "Using slow motion not for dramatic effect, but to highlight a ridiculous or clumsy action for humorous impact." }, { "name": "Obvious Disguise", "desc": "A character wears a laughably unconvincing disguise (like a fake mustache) that somehow fools everyone around them." }, { "name": "Spit-Take", "desc": "A character, surprised while drinking, spits their beverage out in a comical spray." }, { "name": "Meet Cute", "desc": "The charming, unusual, or funny first encounter between two characters who will eventually become a romantic couple." }, { "name": "Record Scratch", "desc": "The music abruptly stops, often accompanied by a record scratch sound effect, as a character freezes the frame to narrate or react to a shocking moment." }, { "name": "Hiding a Body", "desc": "Characters find themselves in a farcical situation where they must hide a dead (or unconscious) body from others, leading to escalating chaos." }, { "name": "Wacky Misunderstanding", "desc": "The central conflict or a major comedic set piece is driven by a simple misunderstanding that characters refuse to clear up." }, { "name": "Awkward Silence", "desc": "A conversation comes to a dead stop, and the resulting silence is held for an uncomfortably long time to create comedic tension." }, { "name": "Oversized Object", "desc": "An everyday object is presented in a comically large size for humorous effect." }, { "name": "Ironic Echo", "desc": "A line of dialogue is repeated in a different context later in the film, giving it a new, usually funny, meaning." }, { "name": "Funny Foreigner", "desc": "A character from another country is portrayed with exaggerated stereotypes for comedic purposes." }, { "name": "Sarcastic Wit", "desc": "A character, often the sidekick, provides a constant stream of dry, sarcastic commentary on the unfolding events." }, { "name": "Slapstick", "desc": "Physical comedy involving clumsy actions, exaggerated violence, and humorous accidents." }, { "name": "Mistaken Identity", "desc": "The entire plot, or a significant part of it, revolves around a character being mistaken for someone else." }, { "name": "The Straight Man", "desc": "A serious, deadpan character who serves as a contrast to the wacky antics of other characters, making them seem even funnier." }, { "name": "Food Fight", "desc": "A scene that erupts into a chaotic battle with food being thrown everywhere." }, { "name": "Cringe Comedy", "desc": "Humor derived from socially awkward situations that make the audience feel embarrassed for the characters." }, { "name": "He's Behind Me", "desc": "A character is talking about someone, unaware that the person is standing right behind them, until it's too late." }, { "name": "Let's Split Up!", "desc": "In a moment of questionable judgment, a group decides to split up to cover more ground, usually with disastrously funny results." }, { "name": "Clumsy Protagonist", "desc": "The main character is exceptionally clumsy, leading to a series of physical gags and mishaps." }
                ],
                "Horror": [
                    { "name": "Jump Scare", "desc": "A quiet, tense moment is suddenly interrupted by a loud noise and a shocking image, designed to make the audience jump." }, { "name": "Car Won't Start", "desc": "Just when a character needs to make a quick getaway from the killer, their car's engine sputters and fails to start." }, { "name": "Splitting Up", "desc": "Faced with a threat, the group decides that the worst possible strategy—splitting up—is somehow a good idea." }, { "name": "No Signal", "desc": "In a moment of crisis, a character tries to use their phone only to find there's no reception or the battery is dead." }, { "name": "It Was a Dream", "desc": "A terrifying sequence is revealed to have been just a nightmare, lulling the character (and audience) into a false sense of security." }, { "name": "Walking Killer", "desc": "The killer moves at a slow, deliberate walk, yet somehow always manages to catch up to their sprinting victims." }, { "name": "Mirror Scare", "desc": "A character looks into a mirror. When they look away and then back, a terrifying figure is suddenly standing behind them in the reflection." }, { "name": "Final Girl", "desc": "The last character, usually a resourceful and morally upright young woman, who survives to confront the killer at the end of the film." }, { "name": "Creepy Child", "desc": "A child who is unnaturally calm, speaks in a spooky voice, or seems to know more than they should, often being a conduit for the supernatural." }, { "name": "Ancient Burial Ground", "desc": "The spooky events are explained by the fact that the house was built on an ancient Native American (or other) burial ground." }, { "name": "Don't Go in There!", "desc": "A character hears a strange noise from a dark basement, attic, or closet and decides to investigate it alone, against all common sense." }, { "name": "Found Footage", "desc": "The film is presented as discovered video recordings, often shaky and chaotic, to create a sense of realism and immediacy." }, { "name": "Black Cat", "desc": "A black cat suddenly appears, often as a cheap fake-out scare before the real threat emerges." }, { "name": "Flickering Lights", "desc": "As the supernatural presence grows stronger, the lights in the building begin to flicker or go out entirely." }, { "name": "Based on a True Story", "desc": "The film claims to be based on real events to enhance the feeling of dread and authenticity." }, { "name": "Token Skeptic", "desc": "A character who refuses to believe in the supernatural threat until they become its victim." }, { "name": "Jump Scare Chord", "desc": "A loud, dissonant musical chord that accompanies a jump scare to maximize its impact." }, { "name": "Not Quite Dead", "desc": "The killer, presumed dead, suddenly springs back to life for one final scare." }, { "name": "Old Wise Person", "desc": "An elderly character who knows the history of the evil and provides a cryptic warning that the main characters ignore." }, { "name": "Demonic Possession", "desc": "A character's body is taken over by a malevolent spirit, leading to unnatural contortions and a creepy voice." }, { "name": "Gorn", "desc": "Excessive, graphic violence and gore used to shock and disgust the audience." }, { "name": "The Grudge", "desc": "The supernatural entity is a vengeful spirit, often with long, dark hair covering its face." }, { "name": "Cellar Door", "desc": "A mysterious, often locked, door to a basement or cellar that characters are inexplicably drawn to open." }, { "name": "First to Die", "desc": "The character who is the most obnoxious, promiscuous, or a minority is often the first to be killed." }
                ],
                "Sci-Fi": [
                    { "name": "Hologram", "desc": "Information or communication is displayed via a three-dimensional light projection, often manipulated by hand gestures." }, { "name": "FTL Travel", "desc": "Faster-Than-Light travel is possible, allowing characters to traverse vast interstellar distances in a short amount of time, often with a cool visual effect." }, { "name": "Sentient AI", "desc": "An artificial intelligence becomes self-aware and often questions its purpose or turns against its human creators." }, { "name": "Technobabble", "desc": "A complex problem is solved by a string of impressive-sounding but nonsensical scientific jargon, like 'reversing the polarity of the neutron flow'." }, { "name": "Alien Signal", "desc": "Scientists receive a mysterious, patterned signal from deep space, heralding the first contact with an extraterrestrial intelligence." }, { "name": "Space Lasers", "desc": "Weapons in space fire brightly colored beams of light that are visible and often make 'pew-pew' sounds, despite sound not traveling in a vacuum." }, { "name": "Evil Corporation", "desc": "A powerful, faceless corporation is the true antagonist, prioritizing profits over human lives and ethics." }, { "name": "Sassy Computer", "desc": "The ship's or base's main computer has a distinct, often sarcastic or witty, personality." }, { "name": "Dystopian Future", "desc": "The future society is depicted as a bleak, oppressive world controlled by a totalitarian government or corporation." }, { "name": "Time Paradox", "desc": "Characters travel through time and must deal with the confusing and dangerous consequences of altering the past or future." }, { "name": "Cybernetics", "desc": "Characters have mechanical or electronic parts integrated with their bodies, often questioning the line between human and machine." }, { "name": "Alien Invasion", "desc": "Earth is attacked by a technologically superior extraterrestrial species, forcing humanity to unite and fight back." }, { "name": "The Red Planet", "desc": "Mars is depicted as a key location for colonization, exploration, or the source of a mysterious threat." }, { "name": "Giant Mecha", "desc": "Characters pilot enormous humanoid robots to fight giant monsters or other robots." }, { "name": "Cryosleep", "desc": "Characters are frozen for long space journeys, often waking up to unexpected and dangerous situations." }, { "name": "Memory Wipe", "desc": "A character's memory is erased or altered, leading to a plot centered around discovering their true identity or past." }, { "name": "Captain's Log", "desc": "A character narrates exposition to the audience under the guise of recording a log entry." }, { "name": "Applied Phlebotinum", "desc": "A fictional substance or technology that is the key to the plot and can do whatever the story requires." }, { "name": "Sentient Planet", "desc": "An entire planet is revealed to be a single, conscious organism." }, { "name": "Warp Drive", "desc": "A specific type of FTL travel that involves bending or warping spacetime." }, { "name": "Teleportation", "desc": "Technology exists to instantly transport matter from one location to another, which often goes wrong." }, { "name": "The Prime Directive", "desc": "A rule that forbids interfering with the development of less advanced alien civilizations, which is almost always broken." }, { "name": "Space Elevator", "desc": "A massive structure connecting the surface of a planet to an orbital station." }, { "name": "Portal", "desc": "A gateway to another dimension, planet, or time, often unstable or leading to a dangerous place." }
                ],
                "Fantasy": [
                    { "name": "The Chosen One", "desc": "The protagonist is destined by prophecy to defeat the great evil and save the world, often starting as a humble and unassuming individual." }, { "name": "Ancient Prophecy", "desc": "A cryptic, age-old prediction foretells the events of the story, guiding the characters' actions and motivations." }, { "name": "Wise Old Mentor", "desc": "An elderly, knowledgeable character who guides the hero, provides crucial exposition, and often dies to motivate the hero's growth." }, { "name": "Magical Artifact", "desc": "A powerful object (a sword, a gem, a book) that is central to the plot and is sought by both heroes and villains." }, { "name": "The Quest", "desc": "The main plot revolves around a long journey to a specific destination to achieve a crucial goal, like destroying the magical artifact." }, { "name": "Elegant Elves", "desc": "A race of ancient, graceful, and wise beings, often skilled with bows and connected to nature, who look down on the younger races." }, { "name": "Grumpy Dwarves", "desc": "A race of short, stout, and bearded warriors and craftsmen who live underground, love gold, and are often gruff and stubborn." }, { "name": "Dark Lord", "desc": "The main villain is an all-powerful, purely evil entity, often clad in black armor, who commands vast armies from a dark fortress." }, { "name": "The Fellowship", "desc": "A diverse group of companions from different races and backgrounds who band together to undertake the quest." }, { "name": "You Shall Not Pass!", "desc": "A character makes a heroic last stand against an overwhelming foe at a narrow passage to allow their friends to escape." }, { "name": "Power of Friendship", "desc": "The heroes are able to overcome the final challenge not through strength, but through their bond and belief in each other." }, { "name": "Enchanted Forest", "desc": "A mystical forest that is magical, often dangerous, and where normal rules don't apply." }, { "name": "Amulet of Power", "desc": "A specific type of magical artifact, usually a piece of jewelry, that grants the wearer incredible powers." }, { "name": "The Kingdom", "desc": "The story is set in a classic medieval kingdom with a castle, a king, and knights." }, { "name": "Lost Heir", "desc": "A main character is revealed to be the long-lost heir to the throne, destined to reclaim their kingdom." }, { "name": "Loyal Companion", "desc": "The hero has a loyal animal or creature companion who assists them on their quest." }, { "name": "Sword and Sorcery", "desc": "A subgenre focusing on sword-wielding heroes and their adventures involving magic and mythical creatures." }, { "name": "Epic Battle", "desc": "The climax of the film is a massive battle between the forces of good and evil." }, { "name": "Mysterious Stranger", "desc": "A mysterious character appears to provide cryptic advice or help to the hero before disappearing." }, { "name": "Hidden Village", "desc": "A secret, isolated community of magical beings (like elves or wizards) that is hidden from the outside world." }, { "name": "The Siege", "desc": "A major plot point involves the heroes defending a castle or fortress from a prolonged attack by the villain's army." }, { "name": "Talking Animal", "desc": "Animals can talk and often provide comic relief or sage advice." }, { "name": "Magic A is Magic A", "desc": "The magic system has clear, consistent rules that are established and followed throughout the story." }, { "name": "Dragons!", "desc": "The story features dragons, either as wise and ancient beings or as fearsome, treasure-hoarding monsters." }
                ]
            };
            const GENRE_MAP = {
                "Action": "Action", "Adventure": "Action", "Thriller": "Action", "War": "Action",
                "Western": "Action", "Crime": "Action", "Comedy": "Comedy", "Romance": "Comedy",
                "Horror": "Horror", "Mystery": "Horror", "Science Fiction": "Sci-Fi", "Fantasy": "Fantasy",
                "Animation": "Fantasy", "Family": "Fantasy"
            };
            const TMDB_GENRES = {
                "Action": 28, "Comedy": 35, "Fantasy": 14, "Horror": 27, "Sci-Fi": 878
            };
            const GENRE_ID_TO_NAME = {
                28: 'Action', 12: 'Adventure', 16: 'Animation', 35: 'Comedy', 80: 'Crime',
                99: 'Documentary', 18: 'Drama', 10751: 'Family', 14: 'Fantasy', 36: 'History',
                27: 'Horror', 10402: 'Music', 9648: 'Mystery', 10749: 'Romance', 878: 'Sci-Fi',
                10770: 'TV Movie', 53: 'Thriller', 10752: 'War', 37: 'Western'
            };

            // --- DOM ELEMENTS ---
            const setupScreen = document.getElementById('setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const randomScreen = document.getElementById('random-screen');
            const watchlistScreen = document.getElementById('watchlist-screen');
            const statsScreen = document.getElementById('stats-screen');
            const setupForm = document.getElementById('setup-form');
            const genreSelect = document.getElementById('genre-select');
            const welcomeMessage = document.getElementById('welcome-message');
            const errorMessage = document.getElementById('error-message');
            const newGameBtn = document.getElementById('new-game-btn');
            const bingoCard = document.getElementById('bingo-card');
            const winPopup = document.getElementById('win-popup');
            const closeWinPopupBtn = document.getElementById('close-win-popup');
            const tropeDetailPopup = document.getElementById('trope-detail-popup');
            const closeTropePopupBtn = document.getElementById('close-trope-popup');
            const modalOverlay = document.getElementById('modal-overlay');
            const confirmNewGamePopup = document.getElementById('confirm-new-game-popup');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const movieTitleInput = document.getElementById('movie_title');
            const movieSuggestions = document.getElementById('movie-suggestions');
            const randomBtn = document.getElementById('random-btn');
            const backBtn = document.getElementById('back-btn');
            const findRandomBtn = document.getElementById('find-random-btn');
            const reshuffleBtn = document.getElementById('reshuffle-btn');
            const randomGenreSelect = document.getElementById('random-genre-select');
            const randomResults = document.getElementById('random-results');
            const clearBtn = document.getElementById('clear-btn');
            const celebrationOverlay = document.getElementById('celebration-overlay');
            const clearBoardBtn = document.getElementById('clear-board-btn');
            const welcomeScreen = document.getElementById('welcome-screen');
            const bingoBtn = document.getElementById('bingo-btn');
            const watchlistBtn = document.getElementById('watchlist-btn');
            const statsBtn = document.getElementById('stats-btn');
            const homeBtn = document.getElementById('home-btn');
            const watchlistHomeBtn = document.getElementById('watchlist-home-btn');
            const statsHomeBtn = document.getElementById('stats-home-btn');
            const watchlistSearch = document.getElementById('watchlist-search');
            const watchlistSuggestions = document.getElementById('watchlist-suggestions');
            const watchlistContainer = document.getElementById('watchlist-container');
            const addMoviePopup = document.getElementById('add-movie-popup');
            const addToWatchlistBtn = document.getElementById('add-to-watchlist-btn');
            const editMoviePopup = document.getElementById('edit-movie-popup');
            const updateMovieBtn = document.getElementById('update-movie-btn');
            const deleteMovieBtn = document.getElementById('delete-movie-btn');
            const confirmDeletePopup = document.getElementById('confirm-delete-popup');
            const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
            const deleteCancelBtn = document.getElementById('delete-cancel-btn');
            const currentScoreDisplay = document.getElementById('current-score-display');
            const winByPointsBtn = document.getElementById('win-by-points-btn');
            const didNotWinBtn = document.getElementById('did-not-win-btn');
            const remixNameBtn = document.getElementById('remix-name-btn');

            let isGameOver = false;
            let clickTimer = null;
            let debounceTimer;
            let movieToAdd = null;
            let movieToEdit = null;
            let currentBingoCardTropes = [];
            let currentGameScore = 0;

            // --- INITIALIZATION ---
            function initialize() {
                genreSelect.innerHTML = '<option value="auto" selected>Auto-Select Based on Movie</option>';
                randomGenreSelect.innerHTML = '<option value="" selected>Any Genre</option>';
                for (const genreName in TROPES_DATA) {
                    const mainOption = `<option value="${genreName}">${genreName}</option>`;
                    genreSelect.innerHTML += mainOption;
                    const randomOption = `<option value="${TMDB_GENRES[genreName]}">${genreName}</option>`;
                    randomGenreSelect.innerHTML += randomOption;
                }
                const playerName = localStorage.getItem('bingoPlayerName');
                const totalScore = localStorage.getItem('bingoTotalScore') || 0;
                if (playerName) {
                    document.getElementById('player_name').value = playerName;
                    welcomeMessage.textContent = `Welcome back, ${playerName}! | Total Score: ${totalScore}`;
                    welcomeMessage.classList.remove('hidden');
                }
                renderWatchlist();
            }
            
            // --- API CALLS ---
            function debounce(func, delay) { clearTimeout(debounceTimer); debounceTimer = setTimeout(func, delay); }
            async function fetchRandomMovies() { randomResults.innerHTML = '<p>Searching for movies...</p>'; let discoverUrl = `https://api.themoviedb.org/3/discover/movie?api_key=${TMDB_API_KEY}&sort_by=popularity.desc&include_adult=false&vote_count.gte=100`; const genreId = document.getElementById('random-genre-select').value; const yearFrom = document.getElementById('year-from').value; const yearTo = document.getElementById('year-to').value; if (genreId) discoverUrl += `&with_genres=${genreId}`; if (yearFrom) discoverUrl += `&primary_release_date.gte=${yearFrom}-01-01`; if (yearTo) discoverUrl += `&primary_release_date.lte=${yearTo}-12-31`; try { let response = await fetch(discoverUrl); let data = await response.json(); if (!data.results || data.results.length === 0) { randomResults.innerHTML = `<p class="error">No movies found with these filters.</p>`; return; } const totalPages = Math.min(data.total_pages, 500); const randomPage = Math.floor(Math.random() * totalPages) + 1; response = await fetch(`${discoverUrl}&page=${randomPage}`); data = await response.json(); const shuffled = data.results.sort(() => 0.5 - Math.random()); displayRandomResults(shuffled.slice(0, 5)); } catch (error) { console.error("Random fetch error:", error); randomResults.innerHTML = `<p class="error">Could not fetch movies. Please try again.</p>`; } }
            async function fetchMovieSuggestions(query, callback) { if (query.length < 3) { watchlistSuggestions.innerHTML = ''; movieSuggestions.innerHTML = ''; return; } const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`; try { const response = await fetch(searchUrl); if (!response.ok) return; const data = await response.json(); callback(data.results); } catch (error) { console.error("Suggestion fetch error:", error); } }
            async function getMovieData(id) { const detailsUrl = `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_API_KEY}`; try { const response = await fetch(detailsUrl); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); return await response.json(); } catch (error) { console.error("API Error:", error); errorMessage.textContent = "Could not fetch movie data."; return null; } }
            
            // --- UI FUNCTIONS ---
            function displayMovieListItem(movie, container, clickHandler) {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w92${movie.poster_path}` : 'https://placehold.co/60x90/16213e/e0e0e0?text=N/A';
                const year = movie.release_date ? `(${movie.release_date.split('-')[0]})` : '';
                const primaryGenre = movie.genre_ids.map(id => GENRE_ID_TO_NAME[id]).find(name => name) || '';
                const overview = movie.overview || "No synopsis available.";
                const rating = (movie.vote_average / 2).toFixed(1);
                item.innerHTML = `<img class="suggestion-poster" src="${posterUrl}" alt="Poster"><div class="suggestion-info"><strong>${movie.title}</strong><small>${year} ${primaryGenre ? '· ' + primaryGenre : ''}</small><p class="suggestion-overview">${overview}</p><span class="suggestion-rating">Rating: ${rating} ★</span></div>`;
                item.addEventListener('click', () => clickHandler(movie));
                container.appendChild(item);
            }
            function displaySuggestions(movies) { movieSuggestions.innerHTML = ''; if (!movies) return; movies.slice(0, 5).forEach(movie => displayMovieListItem(movie, movieSuggestions, (m) => { movieTitleInput.value = m.title; movieSuggestions.innerHTML = ''; const apiGenres = m.genre_ids.map(id => GENRE_ID_TO_NAME[id]).filter(Boolean); const mappedGenre = apiGenres.map(g => GENRE_MAP[g]).find(g => g !== undefined); if (mappedGenre) { genreSelect.value = mappedGenre; } else { genreSelect.value = 'auto'; } })); }
            function displayWatchlistSuggestions(movies) { watchlistSuggestions.innerHTML = ''; if (!movies) return; movies.slice(0, 5).forEach(movie => displayMovieListItem(movie, watchlistSuggestions, (m) => { watchlistSearch.value = ''; watchlistSuggestions.innerHTML = ''; showAddMoviePopup(m.id); })); }
            function displayRandomResults(movies) { randomResults.innerHTML = ''; if (!movies || movies.length === 0) { randomResults.innerHTML = `<p class="error">No movies found.</p>`; return; } movies.forEach(movie => displayMovieListItem(movie, randomResults, (m) => { movieTitleInput.value = m.title; randomScreen.classList.add('hidden'); setupScreen.classList.remove('hidden'); })); }
            function showTropeDetails(name, desc) { document.getElementById('trope-detail-title').textContent = name; document.getElementById('trope-detail-desc').textContent = desc; tropeDetailPopup.classList.remove('hidden'); modalOverlay.classList.remove('hidden'); }
            function hideAllPopups() { tropeDetailPopup.classList.add('hidden'); winPopup.classList.add('hidden'); confirmNewGamePopup.classList.add('hidden'); modalOverlay.classList.add('hidden'); celebrationOverlay.classList.add('hidden'); addMoviePopup.classList.add('hidden'); editMoviePopup.classList.add('hidden'); confirmDeletePopup.classList.add('hidden'); }
            function createParticles() {
                celebrationOverlay.innerHTML = ''; // Clear old particles
                const colors = ['#e94560', '#f7b733', '#42e9f5', '#ffffff'];
                for (let i = 0; i < 100; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    const size = Math.random() * 8 + 2;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.setProperty('--x', `${(Math.random() - 0.5) * 400}px`);
                    particle.style.setProperty('--y', `${(Math.random() - 0.5) * 400}px`);
                    celebrationOverlay.appendChild(particle);
                }
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    celebrationOverlay.appendChild(confetti);
                }
                 for (let i = 0; i < 5; i++) {
                    const balloon = document.createElement('div');
                    balloon.className = 'balloon';
                    balloon.style.left = `${10 + Math.random() * 80}vw`;
                    balloon.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    balloon.style.animationDelay = `${Math.random()}s`;
                    celebrationOverlay.appendChild(balloon);
                }
            }

            // --- WATCHLIST LOGIC ---
            function getWatchlist() { return JSON.parse(localStorage.getItem('movieWatchlist') || '[]'); }
            function saveWatchlist(list) { localStorage.setItem('movieWatchlist', JSON.stringify(list)); }
            function renderWatchlist() {
                const list = getWatchlist();
                list.sort((a, b) => {
                    if (a.priority !== b.priority) {
                        return b.priority - a.priority; // Higher priority first
                    }
                    return b.dateAdded - a.dateAdded; // Newer first
                });
                watchlistContainer.innerHTML = '';
                if (list.length === 0) {
                    watchlistContainer.innerHTML = '<p>Your watchlist is empty. Search for a movie to add it!</p>';
                } else {
                    list.forEach(movie => {
                        const item = document.createElement('div');
                        item.className = 'watchlist-item';
                        const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w92${movie.poster_path}` : 'https://placehold.co/60x90/16213e/e0e0e0?text=N/A';
                        item.innerHTML = `
                            <div class="priority">${movie.priority}</div>
                            <img class="suggestion-poster" src="${posterUrl}" alt="Poster">
                            <div class="suggestion-info">
                                <strong>${movie.title}</strong>
                                <small>(${movie.release_date.split('-')[0]})</small>
                                <p class="suggestion-overview">${movie.overview}</p>
                            </div>`;
                        item.addEventListener('click', () => showEditMoviePopup(movie));
                        watchlistContainer.appendChild(item);
                    });
                }
            }
            async function showAddMoviePopup(movieId) {
                movieToAdd = await getMovieData(movieId);
                if (!movieToAdd) return;
                document.getElementById('add-movie-poster').src = movieToAdd.poster_path ? `https://image.tmdb.org/t/p/w185${movieToAdd.poster_path}` : 'https://placehold.co/150x225/1a1a1e/e0e0e0?text=N/A';
                document.getElementById('add-movie-title').textContent = movieToAdd.title;
                document.getElementById('add-movie-overview').textContent = movieToAdd.overview;
                document.getElementById('priority-select').value = 3;
                addMoviePopup.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
            }
            function showEditMoviePopup(movie) {
                movieToEdit = movie;
                document.getElementById('edit-movie-poster').src = movie.poster_path ? `https://image.tmdb.org/t/p/w185${movie.poster_path}` : 'https://placehold.co/150x225/1a1a1e/e0e0e0?text=N/A';
                document.getElementById('edit-movie-title').textContent = movie.title;
                document.getElementById('edit-movie-overview').textContent = movie.overview;
                const prioritySelect = document.getElementById('edit-priority-select');
                prioritySelect.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === movie.priority) option.selected = true;
                    prioritySelect.appendChild(option);
                }
                editMoviePopup.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
            }

            // --- STATS LOGIC ---
            function getBingoStats() { return JSON.parse(localStorage.getItem('bingoStats') || '{"wins": 0, "losses": 0, "totalPoints": 0, "gamesPlayed": 0}'); }
            function saveBingoStats(stats) { localStorage.setItem('bingoStats', JSON.stringify(stats)); }
            function getTropeStats() { return JSON.parse(localStorage.getItem('tropeStats') || '{}'); }
            function saveTropeStats(stats) { localStorage.setItem('tropeStats', JSON.stringify(stats)); }
            function renderStats() {
                const bingoStats = getBingoStats();
                const tropeStats = getTropeStats();
                const totalGames = bingoStats.wins + bingoStats.losses;
                const winRate = totalGames > 0 ? ((bingoStats.wins / totalGames) * 100).toFixed(1) : 0;
                const avgPoints = bingoStats.gamesPlayed > 0 ? (bingoStats.totalPoints / bingoStats.gamesPlayed).toFixed(1) : 0;

                document.getElementById('stats-wins').textContent = bingoStats.wins;
                document.getElementById('stats-losses').textContent = bingoStats.losses;
                document.getElementById('stats-win-rate').textContent = `${winRate}%`;
                document.getElementById('stats-total-points').textContent = bingoStats.totalPoints;
                document.getElementById('stats-avg-points').textContent = avgPoints;

                const statsContainer = document.getElementById('trope-stats-container');
                statsContainer.innerHTML = '';
                
                const sortedTropes = Object.entries(tropeStats).sort((a, b) => b[1].seen - a[1].seen);

                if (sortedTropes.length === 0) {
                    statsContainer.innerHTML = '<p>No game data yet. Play a game to see your stats!</p>';
                    return;
                }
                
                sortedTropes.forEach(([name, data]) => {
                    const tropeWinRate = data.seen > 0 ? ((data.won / data.seen) * 100).toFixed(1) : 0;
                    const row = document.createElement('div');
                    row.className = 'stat-row';
                    row.innerHTML = `
                        <div class="trope-name">${name}</div>
                        <div class="trope-seen">${data.seen}</div>
                        <div class="trope-won">${data.won}</div>
                        <div class="trope-rate">${tropeWinRate}%</div>
                    `;
                    statsContainer.appendChild(row);
                });
            }
            function endGame(isWin) {
                if (isGameOver) return;
                isGameOver = true;
                let stats = getBingoStats();
                if (isWin) {
                    stats.wins += 1;
                } else {
                    stats.losses += 1;
                }
                stats.gamesPlayed += 1;
                stats.totalPoints += currentGameScore;
                saveBingoStats(stats);
                confirmNewGamePopup.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
            }

            // --- GAME LOGIC ---
            function generateBingoCard(genre) {
                bingoCard.innerHTML = '';
                currentBingoCardTropes = [];
                const availableTropes = TROPES_DATA[genre];
                if (!availableTropes || availableTropes.length < 24) { bingoCard.innerHTML = `<p class="error">Error: Not enough tropes defined for '${genre}'!</p>`; return; }
                const shuffled = [...availableTropes].sort(() => 0.5 - Math.random());
                let cardTropes = shuffled.slice(0, 24);
                cardTropes.splice(12, 0, { name: "FREE SPACE", desc: "This one is on the house! A classic bingo staple. Double-click to mark it." });
                
                const tropeStats = getTropeStats();
                cardTropes.forEach(trope => {
                    currentBingoCardTropes.push(trope.name);
                    if (!tropeStats[trope.name]) {
                        tropeStats[trope.name] = { seen: 0, won: 0 };
                    }
                    tropeStats[trope.name].seen += 1;

                    const cell = document.createElement('div');
                    cell.className = 'bingo-cell';
                    cell.textContent = trope.name;
                    cell.dataset.desc = trope.desc;
                    if (trope.name === "FREE SPACE") { cell.classList.add('marked'); }
                    cell.addEventListener('click', () => {
                        if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; handleDoubleClick(cell); } 
                        else { clickTimer = setTimeout(() => { clickTimer = null; handleSingleClick(cell); }, 250); }
                    });
                    bingoCard.appendChild(cell);
                });
                saveTropeStats(tropeStats);
            }
            function handleSingleClick(cell) { if (isGameOver) return; const name = cell.textContent; const desc = cell.dataset.desc; showTropeDetails(name, desc); }
            function handleDoubleClick(cell) {
                if (isGameOver) return;
                
                if (cell.classList.contains('marked')) {
                    currentGameScore -= 5;
                } else {
                    currentGameScore += 5;
                }
                currentScoreDisplay.textContent = `Current Score: ${currentGameScore}`;
                cell.classList.toggle('marked');

                if (checkForBingo()) {
                    isGameOver = true;
                    let bingoStats = getBingoStats();
                    bingoStats.wins += 1;
                    bingoStats.gamesPlayed += 1;
                    bingoStats.totalPoints += currentGameScore;
                    saveBingoStats(bingoStats);

                    let tropeStats = getTropeStats();
                    const markedCells = bingoCard.querySelectorAll('.bingo-cell.marked');
                    markedCells.forEach(c => {
                        if(tropeStats[c.textContent]) {
                            tropeStats[c.textContent].won += 1;
                        }
                    });
                    saveTropeStats(tropeStats);

                    updateScore(25);
                    createParticles();
                    celebrationOverlay.classList.remove('hidden');
                    setTimeout(() => {
                        celebrationOverlay.classList.add('hidden');
                        winPopup.classList.remove('hidden');
                        modalOverlay.classList.remove('hidden');
                    }, 2000);
                }
            }
            function updateScore(points) { let currentScore = parseInt(localStorage.getItem('bingoTotalScore') || '0'); currentScore += points; localStorage.setItem('bingoTotalScore', currentScore); }
            function checkForBingo() { const cells = bingoCard.querySelectorAll('.bingo-cell'); const markedIndices = Array.from(cells).map((cell, i) => cell.classList.contains('marked') ? i : -1).filter(i => i !== -1); const winningCombos = [[0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], [0,6,12,18,24], [4,8,12,16,20]]; return winningCombos.some(combo => combo.every(index => markedIndices.includes(index))); }

            // --- EVENT LISTENERS ---
            bingoBtn.addEventListener('click', () => {
                welcomeScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
            });
             watchlistBtn.addEventListener('click', () => {
                welcomeScreen.classList.add('hidden');
                watchlistScreen.classList.remove('hidden');
            });
            statsBtn.addEventListener('click', () => {
                renderStats();
                welcomeScreen.classList.add('hidden');
                statsScreen.classList.remove('hidden');
            });
            homeBtn.addEventListener('click', () => {
                setupScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            });
            watchlistHomeBtn.addEventListener('click', () => {
                watchlistScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            });
            statsHomeBtn.addEventListener('click', () => {
                statsScreen.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            });
            watchlistSearch.addEventListener('input', () => {
                debounce(() => fetchMovieSuggestions(watchlistSearch.value, displayWatchlistSuggestions), 300);
            });
            addToWatchlistBtn.addEventListener('click', () => {
                const list = getWatchlist();
                const priority = parseInt(document.getElementById('priority-select').value);
                movieToAdd.priority = priority;
                movieToAdd.dateAdded = Date.now();
                list.push(movieToAdd);
                saveWatchlist(list);
                renderWatchlist();
                hideAllPopups();
            });
            updateMovieBtn.addEventListener('click', () => {
                const list = getWatchlist();
                const index = list.findIndex(m => m.id === movieToEdit.id);
                if (index > -1) {
                    list[index].priority = parseInt(document.getElementById('edit-priority-select').value);
                    saveWatchlist(list);
                    renderWatchlist();
                }
                hideAllPopups();
            });
            deleteMovieBtn.addEventListener('click', () => {
                editMoviePopup.classList.add('hidden');
                confirmDeletePopup.classList.remove('hidden');
            });
            deleteConfirmBtn.addEventListener('click', () => {
                let list = getWatchlist();
                list = list.filter(m => m.id !== movieToEdit.id);
                saveWatchlist(list);
                renderWatchlist();
                hideAllPopups();
            });
            deleteCancelBtn.addEventListener('click', hideAllPopups);
            randomBtn.addEventListener('click', () => { setupScreen.classList.add('hidden'); randomScreen.classList.remove('hidden'); randomResults.innerHTML = ''; });
            backBtn.addEventListener('click', () => { randomScreen.classList.add('hidden'); setupScreen.classList.remove('hidden'); });
            findRandomBtn.addEventListener('click', fetchRandomMovies);
            reshuffleBtn.addEventListener('click', fetchRandomMovies);
            clearBtn.addEventListener('click', () => { movieTitleInput.value = ''; genreSelect.value = 'auto'; movieSuggestions.innerHTML = ''; errorMessage.textContent = ''; });
            clearBoardBtn.addEventListener('click', () => {
                const cells = bingoCard.querySelectorAll('.bingo-cell');
                cells.forEach((cell, index) => {
                    if (index !== 12) { // Don't unmark the free space
                        cell.classList.remove('marked');
                    }
                });
                isGameOver = false; // Allow playing again
                currentGameScore = 0;
                currentScoreDisplay.textContent = `Current Score: 0`;
            });
            movieTitleInput.addEventListener('input', () => { debounce(() => fetchMovieSuggestions(movieTitleInput.value, displaySuggestions), 300); });
            document.addEventListener('click', (e) => { if (!movieTitleInput.contains(e.target) && !movieSuggestions.contains(e.target)) { movieSuggestions.innerHTML = ''; } });
            setupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorMessage.textContent = '';
                isGameOver = false;
                currentGameScore = 0;
                currentScoreDisplay.textContent = `Current Score: 0`;
                const movieTitle = movieTitleInput.value;
                let playerName = document.getElementById('player_name').value;
                if (!playerName) {
                    const nicknames = ["Ryder Heatwave", "Brock Hardstone", "Rex Thrustwell", "Slate Fistcrunch", "Dirk Hardpec", "Rip Steakface", "Bolt Vanderhuge", "Brick Hardmeat", "Buck Plankchest", "Punch Rockgroin", "Stump Beefgnaw", "Flint Ironstag", "Crunch Buttsteak", "Fist Rockbone", "Stump Chunkman", "Dirk Deadpec", "Roll Fizzlebeef", "Big McLargeHuge", "Smoke Manmuscle", "Buff Drinklots", "Gristle McThornbody", "Splint Chesthair", "Slab Squatthrust"];
                    playerName = nicknames[Math.floor(Math.random() * nicknames.length)];
                }
                localStorage.setItem('bingoPlayerName', playerName);
                const searchResults = await (await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(movieTitle)}`)).json();
                if (!searchResults.results || searchResults.results.length === 0) {
                    errorMessage.textContent = `Movie "${movieTitle}" not found.`;
                    return;
                }
                const movieData = await getMovieData(searchResults.results[0].id);
                if (!movieData) return;
                
                let selectedGenreValue = genreSelect.value;
                let finalGenre;
                if (selectedGenreValue === 'auto') {
                    const apiGenres = movieData.genres.map(g => g.name);
                    const mappedGenre = apiGenres.map(g => GENRE_MAP[g]).find(g => g !== undefined);
                    finalGenre = mappedGenre || Object.keys(TROPES_DATA)[0]; 
                } else {
                    finalGenre = selectedGenreValue;
                }

                document.getElementById('movie-title-display').textContent = movieData.title;
                document.getElementById('player-name-display').textContent = playerName;
                document.getElementById('game-genre').textContent = finalGenre;
                document.getElementById('movie-runtime').textContent = movieData.runtime;
                document.getElementById('movie-rating').textContent = (movieData.vote_average / 2).toFixed(1);
                const poster = document.getElementById('movie-poster');
                if (movieData.poster_path) {
                    poster.src = `https://image.tmdb.org/t/p/w500${movieData.poster_path}`;
                    poster.style.display = 'block';
                } else {
                    poster.style.display = 'none';
                }
                generateBingoCard(finalGenre);
                document.body.classList.remove('main-page-bg');
                document.body.classList.add('game-page-bg');
                setupScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
            });
            newGameBtn.addEventListener('click', () => {
                confirmNewGamePopup.classList.remove('hidden');
                modalOverlay.classList.remove('hidden');
            });
            winByPointsBtn.addEventListener('click', () => endGame(true));
            didNotWinBtn.addEventListener('click', () => endGame(false));
            confirmYesBtn.addEventListener('click', () => {
                hideAllPopups();
                gameScreen.classList.add('hidden');
                setupScreen.classList.remove('hidden');
                document.body.classList.remove('game-page-bg');
                document.body.classList.add('main-page-bg');
                initialize();
            });
            confirmCancelBtn.addEventListener('click', hideAllPopups);
            closeWinPopupBtn.addEventListener('click', hideAllPopups);
            closeTropePopupBtn.addEventListener('click', hideAllPopups);
            modalOverlay.addEventListener('click', hideAllPopups);
            remixNameBtn.addEventListener('click', () => {
                const nicknames = ["Ryder Heatwave", "Brock Hardstone", "Rex Thrustwell", "Slate Fistcrunch", "Dirk Hardpec", "Rip Steakface", "Bolt Vanderhuge", "Brick Hardmeat", "Buck Plankchest", "Punch Rockgroin", "Stump Beefgnaw", "Flint Ironstag", "Crunch Buttsteak", "Fist Rockbone", "Stump Chunkman", "Dirk Deadpec", "Roll Fizzlebeef", "Big McLargeHuge", "Smoke Manmuscle", "Buff Drinklots", "Gristle McThornbody", "Splint Chesthair", "Slab Squatthrust"];
                document.getElementById('player_name').value = nicknames[Math.floor(Math.random() * nicknames.length)];
            });
            
            // --- START THE APP ---
            initialize();
        });
    </script>
</body>
</html>
